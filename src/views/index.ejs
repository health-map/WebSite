<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Shippify</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="icon" href="https://cdn.shippify.co/web/icons/logo-shippify.png" type="image/png" sizes="16x16"/>
    <link rel="icon" href="https://cdn.shippify.co/web/icons/logo-shippify.png" type="image/png" sizes="32x32"/>
    <link rel="stylesheet" type="text/css" href="/stylesheet/dialog.css">
    <link rel="stylesheet" type="text/css" href="/stylesheet/form.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick-theme.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="../styles/filepicker.css" /> -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.5.1/min/dropzone.min.css" />
    <script type="text/javascript" src="https://cdn.shippify.co/service/js/typeahead.bundle.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-104320915-1', 'auto');
      ga('send', 'pageview');

      var signedInUser = <%-JSON.stringify(user)%>;

    </script>
    <% if (environment === "development" || environment === "staging") { %>
      <link href="/monitor/dist/dev/monitor.1.33.19.css" rel="stylesheet">
      <script src="/monitor/dist/dev/monitor.1.33.19.js" type="text/javascript"></script>
    <% } else { %>
      <link href="https://cdn.shippify.co/dash/src/monitor/monitor.1.33.19.css" rel="stylesheet">
      <script src="https://cdn.shippify.co/dash/src/monitor/monitor.1.33.19.js" type="text/javascript"></script>
    <% } %>
    <% if (environment === "development" && tutorial) { %>
      <link href="/tutorial/dist/tutorial.1.2.0.css" rel="stylesheet">
      <script src="/tutorial/dist/tutorial.1.2.0.js" type="text/javascript"></script>
    <% } else if(tutorial) { %>
      <link href="https://cdn.shippify.co/dash/src/tutorial/tutorial.1.2.0.css" rel="stylesheet">
      <script src="https://cdn.shippify.co/dash/src/tutorial/tutorial.1.2.0.js" type="text/javascript"></script>
    <% } %>
    <script src="https://cdn.slaask.com/chat.js?t=n|cdn.slaask.com/chat.js?t=n"></script>
    <script src="/javascript/modules/courier.js"></script>
    <style>
      .icon.mky-icon-criptext::before {
        content: "l";
      }
      .icon.mky-icon-criptext {
        margin: auto;
        margin-top: 10px;
      }
    </style>
  </head>
  <body id="monitor">
    <div id="monitor-content"></div>
    <div id="tutorial-content"></div>
    <% include panels/partials/menu.ejs %>
    <% include panels/partials/chatView.ejs %>
    <script>
      /**
       *
       */
      function setUpExternals() {
        let user = window.userSigned
        if(user && (user.environment=="testing" || (Number(user.companyAccess)!=2 && Number(user.companyAccess)!=3) ) || Number(user.role)==1) {
          console.log("Chat will not run in "+user.environment+" or for user with role "+user.role)

          if(Number(user.companyAccess)==1){

              try{
                  _slaask.init('31b3198afffe5a02cbf7f7d5f2b8ed2c');
              }
              catch(e){
                console.log(e)
              }

          }
          return
        }
        var monkeyUser = {
          name:user.name,
          email:user.email,
          userId:user.id,
          type:'user'
        };
        if(user.monkeyId) {
          monkeyUser.monkeyId=user.monkeyId;
        }
        console.log("connecting with "+JSON.stringify(monkeyUser));
        try {
         initChat(monkeyUser);
        } catch(exception) {
          console.log(' >>> Errot to start Chat <<<'+exception);
        }
      }

      /**
       *
       */
      function openChatConversation(courierId) {
        const courier = window.getCouriers().get((courierId).toString())
        if(!courier) {
          console.log("courier not found "+courierId)
          return;
        }
        $('.mky-button').click();
        console.log("opening chat "+courier.get("id"))
        initConversation({
          id: courier.get("id"),
          monkey_id: courier.get("monkeyId"),
          firstname: courier.get("name"),
          lastname: ""
        });
      }

      /**
       * Listener when a chat is opened for a courier
       */
      window.addEventListener('message',function(event) {
        if(typeof event.data.type !== 'undefined' &&
                  event.data.type != null &&
                  event.data.type === 'ShowShipperMap') {
            const list = event.data.conversation_id.split(":");
            const courierId = list[list.length-1];
            const courier = window.getCouriers().get((courierId).toString())
            if(courier) {
              // TODO: send a message to the map to
              //refocus it ? or open info window of shipper
              //var position = new google.maps.LatLng(shipperInfo['lat'],shipperInfo['lng']);
              console.log("Courier is in store "+courier.get("id"))
            }
            if($(".mky-signature").length) {
              $(".mky-signature").remove()
            }
         }
      })

      window.openChatConversation = openChatConversation;
      $(document).ready(function() {
        setUpExternals()
        Monitor.init(
          {
            signedInUser: signedInUser,
            translations: translations
          },
          document.getElementById('monitor-content')
        );
       if(<%- tutorial %>){
        Tutorial.init(
              {
                signedInUser: signedInUser,
                translations: translations
              },
              document.getElementById('tutorial-content')
            );
       }
         $('.menu-wrapper').click(function(){
            $('.dialog-tutorial-second').css('margin-left','332px');
        });
        $('.mky-button').click(function(){
              $('.shy-routes-of-day-wrapper').css('margin-right',"350px");
        });
        $('.mky-icon-close').click(function(){
          $('.shy-routes-of-day-wrapper').css('margin-right',"0px");
        });
      });
    </script>
  </body>
</html>
